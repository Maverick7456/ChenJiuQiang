# 数据库综合实验报告

#### 2018级金融学（金融与人工智能实验班）

| 姓名   | 学号     | 任务               |
| ------ | -------- | ------------------ |
| 易天灏 | 41803053 | 程序编写与测试     |
| 杜昂   | 41804066 | 案例分析、报告书写 |
| 关家仪 | 41833028 | 绘图、程序编写     |
| 于思琪 | 41806056 | 绘图               |
| 陆胤利 | 41832018 | 报告书写、案例分析 |



## 1 数据库编程

​		酒店管理系统具有房间管理、预订、入住登记（check in）、换房、记账消费（如：餐饮或其它商品）、退房（check out）、账务处理等主要功能。通过房间管理功能，设置房间类型、房间位置、房间特征、房间状态、最多容纳人数、房间邻接顺序。房间类型包括标准间、风景间、套房等。房间状态主要包括维护、空闲、预留、占用，其中预留状态指当日已经预订、还未入住，占用状态指已经入住、还未退房。根据预订、入住、换房、退房情况，动态更新房间状态。根据房间类型，确定房间价格。根据入住率，动态调整房间价格折扣。设计酒店管理系统数据库，编写 $SQL$ 代码，实现和测试下列功能，提供程序运行截图。



### 1.1 创建基本关系表，定义关系属性及其联系，选取合适的数据类型和长度，确定表的主码、外码，定义必要的列级约束和表级约束。采集测试数据，输入到关系表。

```sql

```







### 1.2 创建视图。查询位于3楼、共需接待11人的当日空闲、且相邻的标准间。

```sql

```







### 1.3 创建存贮过程，实现团队入住登记功能，主要记录团队成员姓名、证件号码、房间号、计划入住天数。

```sql

```







### 1.4 创建存贮过程，实现换房功能，记录换房前入住房间的退房日期和时间。

```sql

```







### 1.5 创建存贮过程，实现退房功能，计算实际入住天数和总费用（房费和记账消费），显示详细费用清单（包括换房涉及到的不同房间费用、记账消费），记录退房日期和时间。

```sql

```







### 1.6 创建存贮过程，根据基础数据，自动生成当日、未来15日房态信息。房态表参考列名：顺序号、房间号、$F0$(当日房态)、$F1$、$F2$、$F3$、...、$F15$(未来1——15日房态)。

```sql

```







### 1.7 基于预订、入住、换房、退房涉及到的基本表，建立触发器，自动更新当前房间状态。

```sql

```







### 1.8 基于退房涉及到的基本表，建立触发器，自动记录入住天数大于3天或消费金额大于1000的VIP常旅客消费信息（日期、姓名、证件号码、支付金额）。

```sql

```







### 1.9 创建存贮过程，当调价窗口期（如：2个月）到来时，某些房间类型的入住率大于90%，上浮该房间类型的价格20%；入住率小于60%，价格下降20%，且不低于100。

```sql

```









## 2. 案例分析

分析典型票务系统，改进设计相关数据库，提升系统性能。 



### 需求概述 ###

**业务: **查询，购票，退票、中转、改签、候补购票

**数据结构: **车次、车票信息、座位号、购票人、订单信息、车站、支付信息、账目、出售的座位信息、线路、候补购票信息



### 数据结构 ###

**车次: **车次编号、座位数(物理)、座位数(线上)、商务座数、一等座数、二等座数、始发站、终点站、始发时间、终止时间

**线路: **始发站、终点站、途经车站(顺序)

**座位数据: **车次编号、起始站、到达站、起始时间、到达时间、已出售商务座数、已出售一等座数、已出售二等座、允许发售时间

**车票信息: **订单号、购票人信息、乘车人、出发时间、到达时间、出发地、目的地、车次、座位号、选座偏好、订餐、席位类别

**购票人: **购票人信息(姓名、身份证号、性别)、历史订单编号、是否限制乘车、优惠状态(未成年、学生)

**出售的座位信息: **车次编号、起始站、到达站、座位类别、座位号、乘车人、候补

**车站: **车站名称、始发车次、终到车次、过站车次、车站等级(特等、12345等)

**订单信息: **订单号、购票人、成交时间、车票信息、支付状态、支付信息

**支付信息: **订单金额、聚合支付信息、是否更改、更改状态

**账目: **订单号、订单金额、订单状态

**候补购票信息: **候补单号、购票人、下单时间、车票信息、支付状态、支付信息、排位、截止时间



### 2.1 操作使用铁路票务网（www.12306.cn），分析其主要功能。

12306主要有如下6种功能，票务为其中心。

- **查询: **输入(出发地、目的地、出发日)，返回(车次、过站、时间、价格、每种座位的余票数量)
- **订票: **输入订单信息，判断是否可以出票，如是则分配座位号并出票，订单状态=待支付
- **支付: **输入聚合支付信息，修改订单状态=已支付
- **退票: **输入订单信息，退款、回收座位、注销车票、修改订单状态=已退款
- **中转: **如果经查询没有直达车次，在铁路有向图寻找最短路径(按价格、时间排序)，返回车次
- **改签: **输入(订单信息、更新信息)，判断允许改签，更新订单信息、可用票数，计算差价，订单支付状态=0，更新支付信息: 是否更新(1)，更新状态(待退款/待补差价)
- **候补购票: **无票时可以候补排队，余票自动购买，有截止日期，可取消



### 2.2 绘制支撑该系统的数据实体关系图。

![SQL-TERM-2-2](C:\Users\15224\Desktop\SQL-TERM-2-2.jpg)

###  

### 2.3 设计支撑该系统的数据库逻辑结构。 





### 2.4 分析该系统存在的问题或不足

据分析，目前我们分析并构建的12306购票系统结构仍存在以下问题：

##### （1）无性能优化

系统较简单，暂未涉及性能优化。

##### （2）未涉及并发处理

该系统尚未具备负载均衡能力，当同时在线用户数量较大时，系统有无法支撑的风险。

##### （3）未涉及容灾备份

目前分析出的系统结构仍不具备较好的备份能力，容灾备份一般应有多个备份点或定时备份以应对意外宕机的情况。

##### （4）查询中转时未区分车站等级、铁路局、客运段

现实中的铁路网拥有不同等级和用途的车站，如铁路枢纽、大城市等客流量较大的车站，以及成都东站、南宁东站这样专门为高铁修建的车站。那么在路径规划上，就需要考虑各个站点在线路上的权重以及人流等条件。

##### （5）没有候补车票功能、无订餐功能

候补车票功能是当车票余量不足时，用户可选择候补，等待其他已购买相应车次的乘客退票或改签，增加余量后，再根据排队顺序获取购买车票的资格。

在当下，后部车票已是12306常见的功能，也是大量用户经常使用的选项之一。该系统的票务结构中尚缺少对候补车票的处理程序，无法在类似春运、节假日的时段应对大量的购买需求以及更多退票、改签情况，需进一步改进。

订餐配送功能是当下我国铁路运行服务的特色服务。类似于外卖点餐配送，动车、高铁旅客可在12306 $app$ 上订餐，并到站领取。 

根据上述数据实体关系图及逻辑结构，本组分析及构建的12306系统缺少上述的订餐配送功能。 

##### （6）资金处理简单

一般而言，购票用户会使用微信、支付宝、银联等多种支付方式，这需要系统在购买、归款等流程进行甄别和分类等。同样的，目前的资金处理方式显然不善于应对用户较多的情况。

在分析过程中，整个系统的重心为车票的购买、退票订票、改签、路线规划等票务功能，资金处理为此之外另一课题，需进一步分析讨论，加以修正完善。



### 2.5 为了进一步提高系统的可靠性、可用性、安全性和并发处理能力，提出改进方法：数据库优化途径、安全管理措施、数据维护策略

#### 2.5.1 数据库优化途径

分布式集群部署

以上，由阿里云提供技术支持

更新聚合支付功能

加入车站等级、铁路局、客运段，加快中转查询速度

加入车站订餐功能（查询过站可以提供的餐食、加入支付信息）



#### 2.5.2 安全管理措施

容灾手段(双火机房、节点容错、服务器灾备等)

以上，由阿里云提供技术支持



#### 2.5.3 数据维护策略

以上，由阿里云提供技术支持







### 2.6 结合订票、改签、中转、退票、支付等具体业务，提供数据处理过程及其算法

经总结，数据处理过程可简化为如下算法。

```sql
车票信息 = 查询余票(出发地、目的地、出发日){
    车票信息 = 车次，过站，时间，价格，每种座位的余票数量。
}
```

**购票：**购票分为订票和付款两个阶段，先出票(占座)再付款 

**余票数量: **根据订单信息，拿到出发地和目的地，获取这段区间里的所有的原子区间。尝试将每个原子区间的可用票数减1，如果所有的原子区间都够减，则有余票。



#### 2.6.1 订票和支付

```sql
(车票信息、订单信息) = 订票(订单信息){
    if !允许购票(订单信息)
        拒绝订票
    查询余票;
    选择可用的座位;
    车票信息 = 车次，时间，价格，座位号、席位类别、
    支付状态=0;
    根据优惠状态确定价格
    订单状态=待支付
    更新一次出票时所有原子区间的可用票数，用于判断下次是否能出票;
    维护所有已售出的票，用于为选择可用座位提供依据;
}

(车票信息、订单信息) = 支付(订单信息、支付信息){
    验证交易成功
    支付状态=1
    订单状态=完成
}

某种座位的余票数量 = 余票数量(车次、席位类别、出发地、目的地、出发日){
    遍历(各区间): 
        x(i) = 座位数据(车次、席位类别、出发日).(出票限制-各区间占用情况)*1(在允许发售时间)
    某种座位的余票数量 = min(x)
}

0/1 = 允许购票(订单信息){
    乘车人不超过5个
    乘车人不被限制乘车
    乘车人没有同时间段其他车票
}
```



#### 2.6.2 改签

```sql
订单信息 = 改签(订单信息、更新信息){
    判断允许改签
    更换订单信息
    更新可用票数
    查询候补

    计算差价
    支付状态=0
    更新支付信息: 是否更新(1)，更新状态(待退款/待补差价)
}
```



#### 2.6.3 中转

```sql
中转车票信息 = 查询中转((出发地、目的地、出发日){
    铁路有向图寻找最短路径(价格排序)
    铁路有向图寻找最短路径(时间排序)
}
```



#### 2.6.4 退票

```sql
(车票信息、订单信息) = 退票(订单号){
    车票信息注销
    订单状态=退票
    返还金额
    更新可用票数
    查询候补
}
```



#### 2.6.5 候补购票

```sql
(候补购票信息) = 候补购票(购票人、下单时间、车票信息、截止时间){
    if !允许购票
        拒绝订票
    支付状态=0;
    根据优惠状态确定价格
    订单状态=待支付
    查询已有候补、确定排位
}

(候补购票信息) = 取消候补购票(候补购票信息){
    订单状态=取消候补购票
    退款
    更新候补排位
}
```

候补检查: 每日检查到期候补订单，取消之并退款，更新其余候补排位



### 参考资料

[1] https://juejin.cn/post/6844903949632274445

[2] https://blog.csdn.net/weixin_34216196/article/details/90689834?utm_medium=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.control&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.control

[3] https://blog.csdn.net/tanga842428/article/details/79142296

